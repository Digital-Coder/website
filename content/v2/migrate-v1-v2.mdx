# Migrating v1 to v2

Umami v2 introduces a redesigned schema and a number of breaking changes.

## Breaking changes

- The API endpoints have changed including new ones being added. See [API](/docs/api) for more information.
- The tracker script has been renamed from `umami.js` to `script.js`.
- The collect api endpoint has been renamed from `/api/collect` to `/api/send`.
- The tracker no longer uses CSS class names to trigger events. It now uses HTML data attributes. See [Track events](/docs/track-events) for more information.
- The methods on the global `umami` Javascript object have changed. There is now a single `.track()` method and a new way to send event data.
  See [Tracker functions](/docs/tracker-functions) for more information.
- Umami do not longer append the `.js` extension for custom names of the tracker script. This could result in a 404 error if you have a custom name without the `.js` extension and are trying to access the script with extension. For more details, check the section below.

### Tracker scripts with custom names

You can define a custom name for your tracker script by setting the `TRACKER_SCRIPT_NAME` [environment variable](/docs/environment-variables). In Umami v1, the `.js` extension was automatically appended to the custom name. In Umami v2, the `.js` extension is not appended anymore. This could result in a 404 when migrating from v1 to v2.

As an example, previously in v1, by setting the env to `TRACKER_SCRIPT_NAME=custom-script` the tracker script was available at `/custom-script.js`. In v2, with the same env value, the tracker script is available at `/custom-script`. If you are trying to access the script with the `.js` extension as in v1, you will get a 404 error under v2.

The solution to this is to either add the `.js` extension to the `TRACKER_SCRIPT_NAME` env variable or to update the `<script>` tag in your website to fetch the script without the `.js` extension. Having or not the `.js` extension will not affect the load of the script, as long as you are accessing the script at the correct path.

If you are not sure about how to proceed, you can always replace the **Tracking code** (the `<script>` tag that loads the Umami script) from your website with the one generated by the Umami dashboard, that will always have the right value. You can find how to do this under [Collect data](/docs/collect-data) section in the docs.

## Data migration

Due to the schema changes, your data in your v1 database needs to be converted into v2.
To assist with the migration we created a script `@umami/migrate-v1-v2` that will migrate all of your data for you.

### Requirements

- Database schema must be in sync with the latest v1 version (v1.4.0). The script will query the prisma migrations table to ensure the latest migrations have been ran.

### Important

- Backup your target database prior to use. Potential data loss may occur if the migration is interrupted.
- For users with larger datasets (5M+), the migration may take while. Please plan accordingly.
- The script will NOT migrate any event data into v2.
- The script will ask you if you want to drop your v1 tables after the migration is complete.
- If an `event_data` table is found populated with data, it will be renamed to `v1_event_data` but not dropped.

### Troubleshooting

- If your `DATABASE_URL` is localhost and the migration can't connect to the database, try changing to an IP address, for example: `127.0.0.1`.

## Running migration

There are two ways to run the migration script.

### 1. Running inside the Umami folder

Use this method if you have terminal access to your application folder.
Make sure your application is already built. If not run `yarn build` first.

```shell
cd umami
npx @umami/migrate-v1-v2@latest
```

### 2. Running standalone

Use this method if you don't have access to your application folder like when deployed to Vercel or Netlify.

### Install

```shell
git clone https://github.com/umami-software/migrate-v1-v2.git
cd migrate-v1-v2
yarn install
yarn build
```

### Configure

Create an `.env` file with the following variable defined:

```
DATABASE_URL={connection url}
```

### Run

```shell
yarn start
```

## Docker migration

Go into your running docker container. You can find the name by the output of `docker ps`.

```shell
docker exec -ti -u 0 <app container name> sh
```

Run the migration script

```shell
npx @umami/migrate-v1-v2@latest
```

When the migration is run successfully, it should like this:

<img src="/images/v2/migrate-v1-v2.png" />
